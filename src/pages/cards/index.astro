---
// src/pages/cards/index.astro
import Layout from '../../layouts/Layout.astro';
import CardTableContainer from '../../components/CardTableContainer.tsx';
import { getCollection } from 'astro:content';
import { CARD_NETWORKS } from '../../constants';

let allCardsRaw = [];
try {
  allCardsRaw = await getCollection('cards');
} catch (error) {
  console.error('Error loading cards:', error);
  allCardsRaw = []; // Fallback to empty array on error
}

// Process cards to handle tiers and promote representative data
const allCards = allCardsRaw.map((card) => {
  if (!card.data.cardTiers || card.data.cardTiers.length === 0) {
    return card; // Return unmigrated card as is
  }

  const representativeTier =
    card.data.cardTiers.find((t) => t.recommended) || card.data.cardTiers[0];
  if (!representativeTier) {
    return card; // Should not happen if cardTiers is not empty
  }

  const promotedData = {
    network: representativeTier.virtualNetwork || representativeTier.physicalNetwork,
    cardType:
      representativeTier.isVirtual && representativeTier.isPhysical
        ? 'both'
        : representativeTier.isVirtual
          ? 'virtual'
          : 'physical',
    transactionFee: representativeTier.fees?.transactionFee,
    annualFee: representativeTier.fees?.annualFee ? true : false, // Simplified for now
    ...representativeTier,
    ...representativeTier.fees,
    ...representativeTier.rewards,
  };

  return {
    ...card,
    data: {
      ...card.data,
      ...promotedData,
    },
  };
});

// Initial sort: by publish date
allCards.sort(
  (a, b) =>
    new Date(b.data.publishDate || 0).getTime() - new Date(a.data.publishDate || 0).getTime()
);
---

<Layout title="U卡评测列表 - 专业的数字货币U卡评测">
  <div class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100">
    <!-- Hero Section -->
    <section
      class="relative overflow-hidden bg-gradient-to-br from-indigo-600 via-purple-600 to-blue-700 py-20"
    >
      <div
        class="absolute inset-0 bg-[radial-gradient(circle_at_50%_50%,rgba(255,255,255,0.1),transparent_70%)]"
      >
      </div>
      <div
        class="absolute left-0 top-0 h-96 w-96 -translate-x-48 -translate-y-48 rounded-full bg-white/10 blur-3xl"
      >
      </div>

      <div class="relative mx-auto max-w-7xl px-6 text-center lg:px-8">
        <div
          class="mb-8 inline-flex items-center rounded-full border border-white/30 bg-white/20 px-4 py-2 text-sm font-medium text-white/90 backdrop-blur-sm"
        >
          <span class="mr-2 h-2 w-2 animate-pulse rounded-full bg-green-400"></span>
          实时更新 · 专业评测
        </div>

        <h1 class="mb-6 text-5xl font-bold text-white lg:text-6xl">
          全球顶级 <span
            class="bg-gradient-to-r from-yellow-300 to-pink-300 bg-clip-text text-transparent"
            >数字货币U卡</span
          >
        </h1>

        <p class="mx-auto mb-8 max-w-3xl text-xl text-white/90">
          深度评测市场主流数字货币卡片，帮您找到最适合的加密支付方案
        </p>

        <div class="flex flex-wrap justify-center gap-4">
          <div class="rounded-full border border-white/30 bg-white/20 px-6 py-3 backdrop-blur-sm">
            <span class="font-semibold text-white">{allCards.length}+ 卡片评测</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Main Content with Card Table -->
    <section class="px-6 py-16 lg:px-8">
      <div class="mx-auto max-w-7xl">
        <CardTableContainer client:load />
      </div>
    </section>
  </div>
</Layout>
