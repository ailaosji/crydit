---
import { type CollectionEntry, getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import GiscusComments from '../../components/GiscusComments.astro';
import TierComparison from '../../components/card/TierComparison.tsx';
import CardDetailHero from '../../components/card/CardDetailHero.tsx';
import ProConsCard from '../../components/card/ProConsCard.tsx';
import ReviewHighlights from '../../components/card/ReviewHighlights.tsx';
import MobileBottomCTA from '../../components/card/MobileBottomCTA.tsx';
import { CARD_NETWORKS } from '../../constants';

export async function getStaticPaths() {
  try {
    const cards = await getCollection('cards');
    if (!cards || cards.length === 0) {
      console.warn('No cards found in collection');
      return [];
    }
    return cards.map((card) => ({
      params: { slug: card.slug },
      props: { card },
    }));
  } catch (error) {
    console.error('Error loading cards collection:', error);
    return [
      {
        params: { slug: 'error' },
        props: { error: true },
      },
    ];
  }
}

interface Props {
  card?: CollectionEntry<'cards'>;
  error?: boolean;
}

const { card: rawCard, error } = Astro.props as Props;

if (error) {
  // Error handled in template
}

// Process card to handle tiers
let card = rawCard;
if (rawCard?.data.cardTiers && rawCard.data.cardTiers.length > 0) {
  const representativeTier =
    rawCard.data.cardTiers.find((t) => t.recommended) || rawCard.data.cardTiers[0];
  if (representativeTier) {
    const promotedData = {
      network: representativeTier.virtualNetwork || representativeTier.physicalNetwork,
      cardType:
        representativeTier.isVirtual && representativeTier.isPhysical
          ? 'both'
          : representativeTier.isVirtual
            ? 'virtual'
            : 'physical',
      isVirtual: representativeTier.isVirtual,
      isPhysical: representativeTier.isPhysical,
      virtualNetwork: representativeTier.virtualNetwork,
      physicalNetwork: representativeTier.physicalNetwork,
      ...representativeTier.fees,
      ...representativeTier.rewards,
    };
    card.data = { ...rawCard.data, ...promotedData };
  }
}

if (!card) {
  throw new Error('Card not found');
}

const {
  title,
  name,
  description,
  logo,
  cardImage,
  network,
  cardType,
  pros,
  cons,
  features,
  limits,
  rewards,
  issuer,
  supportedRegions,
  applicationDocuments,
  supportedCurrencies,
  supportedPaymentMethods,
  virtualCardPrice,
  physicalCardPrice,
  depositFee,
  transactionFee,
  foreignExchangeFee,
  withdrawalFee,
  annualFee,
  affiliateLink,
  invitationCode,
  importantReminders,
  cardTiers,
  featured,
  recommended,
  kycRequired,
  cashback,
} = card.data;

// Related cards
const allCards = await getCollection('cards');
const relatedCards = allCards
  .map((otherCard) => {
    if (otherCard.slug === card.slug) return { card: otherCard, score: -1 };
    let score = 0;
    if (otherCard.data.network === network) score += 3;
    const commonTags = (card.data.tags || []).filter((tag) =>
      (otherCard.data.tags || []).includes(tag)
    );
    score += commonTags.length * 2;
    const commonCurrencies = (card.data.supportedCurrencies || []).filter((currency) =>
      (otherCard.data.supportedCurrencies || []).includes(currency)
    );
    score += commonCurrencies.length;
    if (otherCard.data.issuer === issuer) score -= 10;
    return { card: otherCard, score };
  })
  .filter((item) => item.score > 0)
  .sort((a, b) => b.score - a.score)
  .map((item) => item.card)
  .slice(0, 3);

// Related articles
const allArticles = await getCollection('articles');
const relatedArticles = allArticles
  .map((article) => {
    let score = 0;
    const articleTitle = article.data.title.toLowerCase();
    const cardName = name.toLowerCase();
    const cardIssuer = issuer.toLowerCase();
    if ((article.data.relatedCards || []).includes(card.slug)) score += 10;
    if (articleTitle.includes(cardName)) score += 5;
    if (articleTitle.includes(cardIssuer)) score += 3;
    const commonTags = (card.data.tags || []).filter((tag) =>
      (article.data.tags || []).includes(tag)
    );
    score += commonTags.length * 2;
    return { article, score };
  })
  .filter((item) => item.score > 0)
  .sort((a, b) => b.score - a.score)
  .map((item) => item.article)
  .slice(0, 4);

const { Content } = await card.render();

// è®¡ç®—å¼€å¡è´¹
const openingFee = virtualCardPrice ?? physicalCardPrice ?? 0;

// Payment method info helper
import { getCurrencyInfo } from '../../config/site-data';
function getPaymentMethodInfo(method) {
  const method_lower = method.toLowerCase().replace(/\s+/g, '');
  switch (method_lower) {
    case 'applepay':
      return { name: 'Apple Pay', icon: 'ğŸ', color: 'bg-gray-900 text-white' };
    case 'googlepay':
      return { name: 'Google Pay', icon: 'ğŸ”µ', color: 'bg-blue-500 text-white' };
    case 'alipay':
      return { name: 'Alipay', icon: 'ğŸ’™', color: 'bg-blue-600 text-white' };
    case 'wechatpay':
      return { name: 'WeChat Pay', icon: 'ğŸ’š', color: 'bg-green-500 text-white' };
    default:
      return { name: method, icon: 'ğŸ’³', color: 'bg-gray-500 text-white' };
  }
}

// Structured data for SEO
const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'Product',
  name: name,
  description: description,
  brand: { '@type': 'Brand', name: issuer },
  offers: {
    '@type': 'Offer',
    price: openingFee || '0',
    priceCurrency: 'USD',
    availability: 'https://schema.org/InStock',
  },
  category: 'Financial Services',
};
---

<Layout title={error ? 'Error' : title || `${name} - Uå¡è¯„æµ‹`}>
  {error ? (
    <div class="container mx-auto my-12 text-center">
      <h1 class="mb-4 text-4xl font-bold">åŠ è½½é”™è¯¯</h1>
      <p class="text-lg">å¡ç‰‡æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚</p>
    </div>
  ) : (
    <>
      <script slot="head" type="application/ld+json" set:html={JSON.stringify(structuredData)} />

      <div class="min-h-screen bg-gradient-to-br from-gray-50 via-slate-50 to-indigo-50/30">
        
        <!-- Hero åŒºåŸŸ -->
        <CardDetailHero
          client:load
          name={name}
          description={description}
          logo={logo}
          cardImage={cardImage}
          network={network}
          issuer={issuer}
          affiliateLink={affiliateLink}
          featured={featured}
          recommended={recommended}
          openingFee={openingFee}
          annualFee={annualFee}
          cashback={cashback}
          transactionFee={transactionFee}
          supportedRegions={supportedRegions}
          kycRequired={kycRequired}
        />

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="mx-auto max-w-7xl px-4 py-8 sm:px-6 lg:px-8 lg:py-12">
          <div class="grid gap-8 lg:grid-cols-3">
            
            <!-- å·¦ä¾§ä¸»å†…å®¹ -->
            <div class="space-y-8 lg:col-span-2">
              
              <!-- ä¼˜ç¼ºç‚¹å¡ç‰‡ -->
              {(pros?.length > 0 || cons?.length > 0) && (
                <ProConsCard client:load pros={pros} cons={cons} />
              )}

              <!-- è¯¦ç»†ä»‹ç» -->
              <section class="overflow-hidden rounded-3xl bg-white shadow-xl">
                <div class="border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white px-6 py-4 lg:px-8">
                  <h2 class="text-xl font-bold text-gray-900">è¯¦ç»†ä»‹ç»</h2>
                </div>
                <div class="prose prose-lg max-w-none p-6 lg:p-8 prose-headings:text-gray-900 prose-p:text-gray-600 prose-a:text-indigo-600 prose-strong:text-gray-900">
                  <Content />
                </div>
              </section>

              <!-- ç­‰çº§å¯¹æ¯” -->
              {cardTiers && cardTiers.length > 0 && (
                <section>
                  <TierComparison tiers={cardTiers} client:load />
                </section>
              )}

              <!-- æ¶ˆè´¹é™é¢ -->
              {limits && Object.keys(limits).length > 0 && (
                <section class="overflow-hidden rounded-3xl bg-white shadow-xl">
                  <div class="border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white px-6 py-4 lg:px-8">
                    <h2 class="text-xl font-bold text-gray-900">æ¶ˆè´¹é™é¢</h2>
                  </div>
                  <div class="grid gap-4 p-6 sm:grid-cols-2 lg:grid-cols-3 lg:p-8">
                    {Object.entries(limits).map(([key, value]) => {
                      const limitLabels = {
                        dailySpending: { label: 'æ¯æ—¥æ¶ˆè´¹', icon: 'ğŸ“†' },
                        monthlySpending: { label: 'æ¯æœˆæ¶ˆè´¹', icon: 'ğŸ“…' },
                        singleTransaction: { label: 'å•ç¬”äº¤æ˜“', icon: 'ğŸ’³' },
                        monthlyAtmWithdrawal: { label: 'ATMå–æ¬¾', icon: 'ğŸ§' },
                      };
                      const config = limitLabels[key] || { label: key, icon: 'ğŸ“Š' };
                      return value ? (
                        <div class="flex items-center gap-4 rounded-2xl bg-gradient-to-br from-gray-50 to-white p-4 border border-gray-100">
                          <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-indigo-100 text-2xl">
                            {config.icon}
                          </div>
                          <div>
                            <div class="text-sm text-gray-500">{config.label}</div>
                            <div class="text-lg font-bold text-gray-900">{value}</div>
                          </div>
                        </div>
                      ) : null;
                    })}
                  </div>
                </section>
              )}

              <!-- ç”¨æˆ·è¯„ä»·ç²¾é€‰ -->
              <ReviewHighlights client:load cardName={name} />

              <!-- è¯„è®ºåŒº -->
              <section id="comments" class="overflow-hidden rounded-3xl bg-white shadow-xl">
                <div class="border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white px-6 py-4 lg:px-8">
                  <h2 class="text-xl font-bold text-gray-900">ç”¨æˆ·è¯„è®º</h2>
                </div>
                <div class="p-6 lg:p-8">
                  <GiscusComments />
                </div>
              </section>
            </div>

            <!-- å³ä¾§è¾¹æ  -->
            <div class="space-y-6 lg:sticky lg:top-32 lg:self-start">
              
              <!-- å¿«é€Ÿç”³è¯·å¡ç‰‡ -->
              {affiliateLink && (
                <div class="overflow-hidden rounded-3xl bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600 p-6 text-white shadow-xl">
                  <h3 class="mb-2 text-lg font-bold">å‡†å¤‡å¥½äº†å—ï¼Ÿ</h3>
                  <p class="mb-4 text-sm text-white/80">ç«‹å³ç”³è¯· {name}ï¼Œäº«å—æ•°å­—è´§å¸æ¶ˆè´¹çš„ä¾¿åˆ©</p>
                  <a
                    href={affiliateLink}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="block w-full rounded-xl bg-white py-3 text-center font-semibold text-indigo-600 shadow-lg transition-all duration-300 hover:-translate-y-0.5 hover:shadow-xl"
                  >
                    ç«‹å³ç”³è¯· â†’
                  </a>
                </div>
              )}

              <!-- é‚€è¯·ç  -->
              {invitationCode && (
                <div class="overflow-hidden rounded-3xl bg-white p-6 shadow-xl">
                  <h3 class="mb-3 text-lg font-bold text-gray-900">ä¸“å±é‚€è¯·ç </h3>
                  <div class="mb-3 flex items-center gap-2">
                    <code class="flex-1 rounded-xl bg-gradient-to-r from-amber-50 to-orange-50 px-4 py-3 text-center font-mono text-lg font-bold text-amber-600 border-2 border-dashed border-amber-200">
                      {invitationCode}
                    </code>
                    <button
                      class="rounded-xl bg-amber-100 p-3 text-amber-600 transition-colors hover:bg-amber-200"
                      onclick={`navigator.clipboard.writeText('${invitationCode}'); this.innerHTML='âœ“'`}
                    >
                      <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                      </svg>
                    </button>
                  </div>
                  <p class="text-xs text-gray-500">æ³¨å†Œæ—¶è¾“å…¥æ­¤é‚€è¯·ç å³å¯äº«å—ä¼˜æƒ </p>
                </div>
              )}

              <!-- æ”¯æŒçš„å¸ç§ -->
              {supportedCurrencies && supportedCurrencies.length > 0 && (
                <div class="overflow-hidden rounded-3xl bg-white p-6 shadow-xl">
                  <h3 class="mb-4 text-lg font-bold text-gray-900">æ”¯æŒå¸ç§</h3>
                  <div class="flex flex-wrap gap-2">
                    {supportedCurrencies.slice(0, 10).map((currency) => (
                      <span class="rounded-lg bg-gradient-to-r from-blue-50 to-indigo-50 px-3 py-1.5 text-sm font-medium text-blue-700 border border-blue-100">
                        {currency}
                      </span>
                    ))}
                    {supportedCurrencies.length > 10 && (
                      <span class="rounded-lg bg-gray-100 px-3 py-1.5 text-sm text-gray-500">
                        +{supportedCurrencies.length - 10} æ›´å¤š
                      </span>
                    )}
                  </div>
                </div>
              )}

              <!-- æ”¯æŒçš„æ”¯ä»˜æ–¹å¼ -->
              {supportedPaymentMethods && supportedPaymentMethods.length > 0 && (
                <div class="overflow-hidden rounded-3xl bg-white p-6 shadow-xl">
                  <h3 class="mb-4 text-lg font-bold text-gray-900">æ”¯ä»˜æ–¹å¼</h3>
                  <div class="flex flex-wrap gap-2">
                    {supportedPaymentMethods.map((method) => {
                      const info = getPaymentMethodInfo(method);
                      return (
                        <span class={`inline-flex items-center gap-1.5 rounded-lg px-3 py-1.5 text-sm font-medium ${info.color}`}>
                          {info.icon} {info.name}
                        </span>
                      );
                    })}
                  </div>
                </div>
              )}

              <!-- é‡è¦æé†’ -->
              {importantReminders && importantReminders.length > 0 && (
                <div class="overflow-hidden rounded-3xl border-2 border-amber-200 bg-gradient-to-br from-amber-50 to-orange-50 p-6">
                  <h3 class="mb-3 flex items-center gap-2 text-lg font-bold text-amber-800">
                    <span>âš ï¸</span> é‡è¦æé†’
                  </h3>
                  <ul class="space-y-2">
                    {importantReminders.map((reminder) => (
                      <li class="flex items-start gap-2 text-sm text-amber-700">
                        <span class="mt-1 h-1.5 w-1.5 shrink-0 rounded-full bg-amber-500" />
                        {reminder}
                      </li>
                    ))}
                  </ul>
                </div>
              )}

              <!-- ç›¸å…³Uå¡æ¨è -->
              {relatedCards && relatedCards.length > 0 && (
                <div class="overflow-hidden rounded-3xl bg-white p-6 shadow-xl">
                  <h3 class="mb-4 text-lg font-bold text-gray-900">ç›¸å…³Uå¡</h3>
                  <div class="space-y-3">
                    {relatedCards.map((relatedCard) => (
                      <a
                        href={`/cards/${relatedCard.slug}`}
                        class="flex items-center gap-3 rounded-xl bg-gray-50 p-3 transition-all duration-200 hover:bg-indigo-50 hover:shadow-md"
                      >
                        <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 text-sm font-bold text-white">
                          {relatedCard.data.name.charAt(0)}
                        </div>
                        <div class="min-w-0 flex-1">
                          <div class="truncate font-medium text-gray-900">{relatedCard.data.name}</div>
                          <div class="truncate text-xs text-gray-500">{relatedCard.data.issuer}</div>
                        </div>
                        <svg class="h-4 w-4 shrink-0 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                      </a>
                    ))}
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>

        <!-- ç§»åŠ¨ç«¯åº•éƒ¨å›ºå®šCTA -->
        <MobileBottomCTA
          client:load
          cardName={name}
          affiliateLink={affiliateLink}
          openingFee={openingFee}
          annualFee={annualFee}
        />
      </div>
    </>
  )}
</Layout>

<style>
  /* ç§»åŠ¨ç«¯åº•éƒ¨ç•™ç™½ï¼Œé¿å…è¢«å›ºå®šæ é®æŒ¡ */
  @media (max-width: 768px) {
    .min-h-screen {
      padding-bottom: 100px;
    }
  }
</style>